<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hunt - MMR</title>
  </head>
  <body>
    <pre>
      steam\steamapps\common\Hunt Showdown\user\profiles\default\attributes
    </pre>
    <input type="file" id="input" />
    <div id="raw"></div>
    <pre id="data"></pre>
    <canvas id="chart"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const VLS = "data-v01";
      const reader = new FileReader();
      const $file = document.getElementById("input");
      const $chart = document.getElementById("chart");

      const colors = [
        "Red",
        "Blue",
        "Green",
        "Fuchsia",
        "Maroon",
        "Purple",
        "Olive",
        "Lime",
        "Aqua",
        "Teal",
        "Navy",
        "Yellow",
        "Fuchsia",
      ];

      function readFile(file) {
        return new Promise((res, rej) => {
          let reader = new FileReader();

          reader.readAsText(file);

          reader.onload = function () {
            res(reader.result);
          };

          reader.onerror = function () {
            rej(reader.error);
          };
        });
      }

      function getFileData(raw) {
        const arr = raw.split("\n");
        const data = arr
          .map((v) => {
            const $el = document.createElement("div");
            $el.innerHTML = v;

            const $params = $el.querySelector("attr");

            if ($params) {
              return {
                name: $params.getAttribute("name"),
                value: $params.getAttribute("value"),
              };
            }
            return null;
          })
          .filter((v) => v !== null)
          .filter((v) => /MissionBagPlayer/.test(v.name))
          .filter(
            (v) =>
              /blood_line_name/.test(v.name) ||
              /mmr/.test(v.name) ||
              /profileid/.test(v.name)
          )
          .map((v, i, arr) => {
            if (i % 3 === 0) {
              const id = arr[i + 2].value;
              const user = arr[i].value;
              const mmr = arr[i + 1].value;

              return {
                id,
                user,
                mmr,
              };
            }
            return null;
          })
          .filter((v) => v !== null)
          .sort((a, b) => b.mmr - a.mmr)
          .reduce((acc, v, i) => {
            acc[v.id] = {
              nikname: v.user,
              mmr: [v.mmr, v.mmr, v.mmr],
            };

            return acc;
          }, {});

        return data;
      }

      function render(data) {
        const $data = document.getElementById("data");

        $data.innerHTML = Object.values(data)
          .map((v) => `${v.nikname} = ${v.mmr[0]}`)
          .join("\n");

        const maxCountGame = Math.max(
          ...Object.values(data).reduce((acc, v) => [v.mmr.length, ...acc], [])
        );

        const datasets = Object.entries(data).map(([k, v], i) => {
          return {
            label: v.nikname,
            data: v.mmr,
            backgroundColor: colors[i],
            borderColor: colors[i],
          };
        });

        const configChart = {
          type: "line",
          data: {
            labels: new Array(maxCountGame).fill(null).map((v, i) => i),
            datasets: datasets,
          },
          options: {
            plugins: {
              legend: {
                align: "start",
              },
            },
          },
        };
        const myChart = new Chart($chart, configChart);
      }

      $file.addEventListener("change", async () => {
        const selectedFile = $file.files[0];
        console.log(selectedFile);

        const raw = await readFile(selectedFile);
        const data = getFileData(raw);

        console.log(data);

        render(data);
      });
    </script>
  </body>
</html>
